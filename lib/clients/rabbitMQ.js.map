{"version":3,"sources":["../../src/clients/rabbitMQ.js"],"names":["Client","config","consumeMessageCallback","processing","_consumeMessage","bind","_createQueues","consumeType","removeType","publish","send","_getHeaders","_processMessage","close","options","amqpSettings","ssl","hosts","Array","isArray","host","connection","connect","connectionOptions","channel","createChannel","json","setup","prefetch","assertQueue","queue","name","durable","exclusive","autoDelete","maxPriority","key","handlers","type","replace","assertExchange","bindQueue","deadLetterExchange","retryQueue","arguments","retryDelay","errorQueue","auditEnabled","auditQueue","consume","noAck","emit","addSetup","Promise","all","removeSetup","unbindQueue","endpoint","message","headers","endpoints","map","messageHeaders","ep","messageId","MessageId","hasOwnProperty","priority","Priority","sendToQueue","then","messageType","DestinationAddress","MessageType","SourceAddress","TimeSent","Date","toISOString","TypeName","FullTypeName","ConsumerType","Language","rawMessage","properties","error","catch","ack","result","TimeReceived","DestinationMachine","hostname","JSON","parse","content","toString","undefined","retry","exception","success","TimeProcessed","retryCount","RetryCount","maxRetries","Exception","cancel","deleteQueue","_channel","Object","keys","consumers","wait","time","resolve","_","setTimeout","sleep","milliseconds","start","getTime","i"],"mappings":"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","file":"rabbitMQ.js","sourcesContent":["import {mergeDeep, guid} from '../utils';\r\nimport amqp from 'amqp-connection-manager';\r\nimport os from 'os';\r\nimport EventEmitter from 'events';\r\n\r\n/** Class representing the rabbitMQ client. */\r\nexport default class Client extends EventEmitter {\r\n\r\n  processing = 0;\r\n\r\n  /**\r\n   * Sets config and connects to RabbitMQ\r\n   * @constructor\r\n   * @param  {Object} config\r\n   * @param (Function) consumeMessageCallback\r\n   */\r\n  constructor(config, consumeMessageCallback) {\r\n    super();\r\n    this.config = config;\r\n    this.consumeMessageCallback = consumeMessageCallback;\r\n    this._consumeMessage = this._consumeMessage.bind(this);\r\n    this._createQueues = this._createQueues.bind(this);\r\n    this.consumeType = this.consumeType.bind(this);\r\n    this.removeType = this.removeType.bind(this);\r\n    this.publish = this.publish.bind(this);\r\n    this.send = this.send.bind(this);\r\n    this._getHeaders = this._getHeaders.bind(this);\r\n    this._processMessage = this._processMessage.bind(this);\r\n    this.close = this.close.bind(this);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * Creates connection, creates channel and then sets up RabbitMQ queues and exchanges.\r\n   */\r\n  connect(){\r\n    let options = {};\r\n    if (this.config.amqpSettings.ssl) {\r\n      options = mergeDeep(options, this.config.amqpSettings.ssl);\r\n    }\r\n\r\n    let hosts = Array.isArray(this.config.amqpSettings.host) ? this.config.amqpSettings.host : [this.config.amqpSettings.host];\r\n\r\n    this.connection = amqp.connect(hosts, { connectionOptions: options });\r\n    this.channel = this.connection.createChannel({\r\n      json: true,\r\n      setup: (channel) => {\r\n        channel.prefetch(this.config.amqpSettings.prefetch);\r\n        this._createQueues(channel);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates host queue, retry queue and error queue.  It then sets up handler mappings and begins consuming messages.\r\n   * The connected event is fired after consuming has begun.\r\n   */\r\n  _createQueues(channel){\r\n    // create queue\r\n    channel.assertQueue(this.config.amqpSettings.queue.name,  {\r\n      durable: this.config.amqpSettings.queue.durable,\r\n      exclusive: this.config.amqpSettings.queue.exclusive,\r\n      autoDelete: this.config.amqpSettings.queue.autoDelete,\r\n      maxPriority: this.config.amqpSettings.queue.maxPriority\r\n    });\r\n\r\n    // bind queue to message types\r\n    for(var key in this.config.handlers){\r\n      let type = key.replace(/\\./g, \"\");\r\n\r\n      channel.assertExchange(type, 'fanout', {\r\n        durable: true\r\n      });\r\n\r\n      channel.bindQueue(this.config.amqpSettings.queue.name, type, '');\r\n    }\r\n\r\n    // Create dead letter exchange\r\n    let deadLetterExchange = this.config.amqpSettings.queue.name + \".Retries.DeadLetter\";\r\n    channel.assertExchange(deadLetterExchange, 'direct', {\r\n      durable: true\r\n    });\r\n\r\n    // Create retry queue\r\n    let retryQueue = this.config.amqpSettings.queue.name + \".Retries\";\r\n    channel.assertQueue(retryQueue,  {\r\n      durable: this.config.amqpSettings.queue.durable,\r\n      arguments: {\r\n        \"x-dead-letter-exchange\": deadLetterExchange,\r\n        \"x-message-ttl\": this.config.amqpSettings.retryDelay\r\n      }\r\n    });\r\n\r\n    channel.bindQueue(this.config.amqpSettings.queue.name, deadLetterExchange, retryQueue);\r\n\r\n    // configure error exchange\r\n    channel.assertExchange(this.config.amqpSettings.errorQueue, 'direct', {\r\n      durable: false\r\n    });\r\n\r\n    // create error queue\r\n    channel.assertQueue(this.config.amqpSettings.errorQueue,  {\r\n      durable: true,\r\n      autoDelete: false\r\n    });\r\n\r\n    if (this.config.amqpSettings.auditEnabled)\r\n    {\r\n      // configure audit exchange\r\n      channel.assertExchange(this.config.amqpSettings.auditQueue, 'direct', {\r\n        durable: false\r\n      });\r\n\r\n      // create error audit\r\n      channel.assertQueue(this.config.amqpSettings.auditQueue,  {\r\n        durable: true,\r\n        autoDelete: false\r\n      });\r\n    }\r\n\r\n    channel.consume(this.config.amqpSettings.queue.name, this._consumeMessage, {\r\n      noAck: this.config.amqpSettings.queue.noAck\r\n    });\r\n\r\n    this.emit(\"connected\");\r\n  }\r\n\r\n  /**\r\n   * Starts consuming the message type.  Creates a durable exchange named @message of type fanout.\r\n   * Binds the clients queue to the exchange.\r\n   * @param {string} type\r\n   */\r\n  consumeType(type){\r\n    this.channel.addSetup((channel) => {\r\n      Promise.all([\r\n        channel.assertExchange(type, 'fanout', { durable: true }),\r\n        channel.bindQueue(this.config.amqpSettings.queue.name, type, '')\r\n      ])\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stops listening for the message.  Unbinds the exchange named @type from the client queue.\r\n   * @param {String} type\r\n   */\r\n  removeType(type){\r\n    this.channel.removeSetup((channel) => {\r\n      return channel.unbindQueue(this.config.amqpSettings.queue.name, type);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sends a command to the specified endpoint(s).\r\n   * @param {String|Array} endpoint\r\n   * @param {String} type\r\n   * @param {Object} message\r\n   * @param  Object|undefined} headers\r\n   */\r\n  send(endpoint, type, message, headers = {}) {\r\n    let endpoints = Array.isArray(endpoint) ? endpoint : [endpoint];\r\n\r\n    return Promise.all(endpoints.map(ep => {\r\n      let messageHeaders = this._getHeaders(type, headers, ep, \"Send\");\r\n\r\n      let options = { headers: messageHeaders, messageId: messageHeaders.MessageId };\r\n      if (messageHeaders.hasOwnProperty(\"Priority\")) {\r\n        options.priority = messageHeaders.Priority\r\n      }\r\n      return this.channel.sendToQueue(ep, message, options);\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Published an event of the specified type.\r\n   * @param {String} type\r\n   * @param {Object} message\r\n   * @param {Object|undefined} headers\r\n   */\r\n  publish(type, message, headers = {}){\r\n    let messageHeaders = this._getHeaders(type, headers, this.config.amqpSettings.queue.name, \"Publish\");\r\n\r\n    let options = { headers: messageHeaders, messageId: messageHeaders.MessageId };\r\n    if (messageHeaders.hasOwnProperty(\"Priority\")) {\r\n      options.priority = messageHeaders.Priority\r\n    }\r\n\r\n    return this.channel.addSetup((channel) => {\r\n      return channel.assertExchange(type.replace(/\\./g, \"\"), 'fanout', { durable: true });\r\n    }).then(() => {\r\n      return this.channel.publish(type.replace(/\\./g, \"\"), '', message, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a object containing the standard message headers that need to be sent with all messages.\r\n   * @param {String} type\r\n   * @param {Object} headers\r\n   * @param {String} queue\r\n   * @param {String} messageType\r\n   * @return {Object} headers\r\n   */\r\n  _getHeaders(type, headers, queue, messageType){\r\n    headers = mergeDeep({}, headers || {});\r\n    if (!headers.DestinationAddress) headers.DestinationAddress = queue;\r\n    if (!headers.MessageId) headers.MessageId = guid();\r\n    if (!headers.MessageType) headers.MessageType = messageType;\r\n    if (!headers.SourceAddress) headers.SourceAddress = this.config.amqpSettings.queue.name;\r\n    if (!headers.TimeSent) headers.TimeSent = new Date().toISOString();\r\n    if (!headers.TypeName) headers.TypeName = type;\r\n    if (!headers.TypeName) headers.FullTypeName = type;\r\n    if (!headers.ConsumerType) headers.ConsumerType = 'RabbitMQ';\r\n    if (!headers.Language) headers.Language = 'Javascript';\r\n    return headers;\r\n  }\r\n\r\n  /**\r\n   * Callback called by RabbitMQ when consuming a message.  Calls the consumeMessage callback passed into the client\r\n   * constructor.  If there is an exception the message is sent to the retry queue.  If an exception occurs and the\r\n   * message has been retried the max number of times then the message is sent to the error queue.  If auditing is\r\n   * enabled a copy of the message is sent to the audit queue. Acks the message at the end if noAck is false.\r\n   * @param  {Object} rawMessage\r\n   */\r\n  _consumeMessage(rawMessage){\r\n    this.processing++;\r\n    if (!rawMessage.properties.headers.TypeName){\r\n      this.emit(\"error\", { error: \"Message does not contain TypeName\", message: rawMessage});\r\n      throw {\r\n        error: \"Message does not contain TypeName\",\r\n        message: rawMessage\r\n      }\r\n    }\r\n\r\n    this._processMessage(rawMessage)\r\n      .catch(() => {})\r\n      .then(() => {\r\n        if(!this.config.amqpSettings.queue.noAck){\r\n          this.channel.ack(rawMessage);\r\n        }\r\n        this.processing--;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Processes the RabbitMQ message.  Calls the consumeMessage callback passed into the client\r\n   * constructor.  If there is an exception the message is sent to the retry queue.  If an exception occurs and the\r\n   * message has been retried the max number of times then the message is sent to the error queue.  If auditing is\r\n   * enabled a copy of the message is sent to the audit queue.\r\n   * @param  {Object} rawMessage\r\n   */\r\n  async _processMessage(rawMessage) {\r\n    let result = null,\r\n      headers = rawMessage.properties.headers;\r\n\r\n    try {\r\n\r\n      headers.TimeReceived = headers.TimeReceived || new Date().toISOString();\r\n      headers.DestinationMachine = headers.DestinationMachine || os.hostname();\r\n      headers.DestinationAddress = headers.DestinationAddress || this.config.amqpSettings.queue.name;\r\n\r\n      let message = JSON.parse(rawMessage.content.toString());\r\n\r\n      try {\r\n        await this.consumeMessageCallback(\r\n          message,\r\n          headers,\r\n          headers.TypeName);\r\n      } catch (e) {\r\n        if (e === null || e === undefined ||\r\n          (e !== null && e != undefined && typeof e !== 'object')  ||\r\n          (e !== null && e != undefined && typeof e === 'object' && e.retry !== false)) {\r\n        result = {\r\n          exception: e,\r\n          success: false\r\n        };\r\n        }\r\n      }\r\n\r\n      headers.TimeProcessed = headers.TimeProcessed || new Date().toISOString();\r\n\r\n      // forward to audit queue is audit is enabled\r\n      if(result === null && this.config.amqpSettings.auditEnabled) {\r\n        this.channel.sendToQueue(\r\n          this.config.amqpSettings.auditQueue,\r\n          JSON.parse(rawMessage.content.toString()),\r\n          {\r\n            headers: headers,\r\n            messageId: rawMessage.properties.messageId\r\n          });\r\n      }\r\n\r\n    } catch(ex) {\r\n      result = {\r\n        exception: ex,\r\n        success: false\r\n      };\r\n    }\r\n\r\n    if(result !== null) {\r\n      let retryCount = 0;\r\n      if(headers.RetryCount !== undefined){\r\n        retryCount = headers.RetryCount;\r\n      }\r\n\r\n      if (retryCount < this.config.amqpSettings.maxRetries){\r\n        retryCount++;\r\n        headers.RetryCount = retryCount;\r\n\r\n        this.channel.sendToQueue(\r\n          this.config.amqpSettings.queue.name + \".Retries\",\r\n          JSON.parse(rawMessage.content.toString()),\r\n          {\r\n            headers: headers,\r\n            messageId: rawMessage.properties.messageId\r\n          });\r\n      } else {\r\n        headers.Exception = result.exception;\r\n        this.channel.sendToQueue(\r\n          this.config.amqpSettings.errorQueue,\r\n          JSON.parse(rawMessage.content.toString()),\r\n          {\r\n            headers: headers,\r\n            messageId: rawMessage.properties.messageId\r\n          });\r\n      }\r\n    }\r\n  }\r\n\r\n  stopConsuming() {\r\n    this.channel.cancel();\r\n  }\r\n\r\n  /**\r\n   * Closes RabbitMQ channel.\r\n   */\r\n  async close(){\r\n    if(this.config.amqpSettings.queue.autoDelete){\r\n      this.channel.removeSetup((channel) => {\r\n        return channel.deleteQueue(this.config.amqpSettings.queue.name + \".Retries\");\r\n      });\r\n    }\r\n    // Stop consuming messages.\r\n    await this.channel._channel.cancel(Object.keys(this.channel._channel.consumers)[0])\r\n\r\n    // Wait until all messages have been processed.\r\n    while (this.processing !== 0) {\r\n      await wait(100)\r\n    }\r\n\r\n    // Close connection\r\n    await this.connection.close();\r\n  }\r\n}\r\n\r\nfunction wait(time) {\r\n  return new Promise((resolve, _) => {\r\n    setTimeout(() => resolve(), time);\r\n  });\r\n}\r\n\r\nfunction sleep(milliseconds) {\r\n  var start = new Date().getTime();\r\n  for (var i = 0; i < 1e7; i++) {\r\n    if ((new Date().getTime() - start) > milliseconds){\r\n      break;\r\n    }\r\n  }\r\n}\r\n"]}